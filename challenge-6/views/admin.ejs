<% layout('layout') -%>

<h1>Admin üßë‚Äçüç≥</h1>
<p class="muted">
  Requires JWT (stored in <code>localStorage</code>). Go to <a href="/login">Login</a> first.
</p>

<div class="grid2">
  <div class="card">
    <h2>Create recipe</h2>
    <form id="createForm" class="form">
      <label>Name</label>
      <input name="name" required placeholder="Krabby Patty" />
      <label>Price</label>
      <input name="price" type="number" step="0.01" min="0" required placeholder="5.99" />
      <label>Ingredients (comma separated)</label>
      <input name="ingredients" placeholder="bun, patty, pickles" />
      <label>Description</label>
      <input name="description" placeholder="Tasty..." />
      <button type="submit">Create</button>
    </form>
  </div>

  <div class="card">
    <h2>Recipes</h2>
    <div id="list"></div>
  </div>
</div>

<pre id="out" class="out"></pre>

<script>
const out = document.getElementById('out');
const list = document.getElementById('list');

function token() { return localStorage.getItem('token') || ''; }

function show(obj) {
  out.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
}

async function api(path, options={}) {
  const headers = options.headers || {};
  headers['Content-Type'] = headers['Content-Type'] || 'application/json';
  const t = token();
  if (t) headers['Authorization'] = 'Bearer ' + t;
  const res = await fetch('/api/recipes' + path, { ...options, headers });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw data;
  return data;
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (c) => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

async function load() {
  const items = await api('', { method:'GET', headers:{} });
  list.innerHTML = '';
  if (!Array.isArray(items) || items.length === 0) {
    list.innerHTML = '<p class="muted">No recipes.</p>';
    return;
  }

  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'itemRow';
    div.innerHTML = `
      <div>
        <div class="title">${escapeHtml(item.name)}</div>
        <div class="muted small">$${Number(item.price).toFixed(2)} ‚Ä¢ id: ${item._id}</div>
      </div>
      <div class="actions">
        <button class="secondary" data-edit="${item._id}">Edit</button>
        <button class="danger" data-del="${item._id}">Delete</button>
      </div>
    `;
    list.appendChild(div);
  });
}

document.getElementById('createForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = Object.fromEntries(fd.entries());
  payload.price = Number(payload.price);
  payload.ingredients = (payload.ingredients || '').split(',').map(s => s.trim()).filter(Boolean);

  try {
    const created = await api('', { method:'POST', body: JSON.stringify(payload) });
    show({ ok:true, created });
    e.target.reset();
    await load();
  } catch (err) {
    show(err);
  }
});

list.addEventListener('click', async (e) => {
  const delId = e.target.getAttribute('data-del');
  const editId = e.target.getAttribute('data-edit');

  try {
    if (delId) {
      const r = await api('/' + delId, { method:'DELETE' });
      show({ ok:true, deleted: delId, result: r });
      await load();
    }

    if (editId) {
      const newName = prompt('New name?');
      const newPrice = prompt('New price? (number)');
      if (newName === null && newPrice === null) return;

      const patch = {};
      if (newName) patch.name = newName;
      if (newPrice) patch.price = Number(newPrice);

      const updated = await api('/' + editId, { method:'PATCH', body: JSON.stringify(patch) });
      show({ ok:true, updated });
      await load();
    }
  } catch (err) {
    show(err);
  }
});

(async () => {
  try {
    await load();
  } catch (err) {
    show({ message: 'Login first to use admin CRUD.', err });
  }
})();
</script>
